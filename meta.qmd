---
title: "Meta Data"
bibliography: packages.bib
format: 
  html:
     code-fold: true
     code-summary: "Show the code"
---

```{r}
#| include: false

library(knitr)
library(tidyverse)
library(iBats)
library(gt)

set.seed(214)

```

Many columns would be added to a tidy data set so it becomes more useful for analysis; some of these are described below.

## Date and Time Information

### The *Night*

Bats are active through the night; the date of the night is the date at sunset and lasts until sunrise the morning of the following day. The *Night* is a variable column that is added to the *tidy* data; it is useful convention that helps avoid the confusion of having contiguous bat activity over two dates.

The *Night* can be obtained from the *iBats* package using the `date_time_info` function. It requires a data.frame or tibble with a `DateTime` column, the *iana*[^1] time zone can be specified; the default is `Europe/London`.

[^1]: a full list of time zones can be found here <https://en.wikipedia.org/wiki/List_of_tz_database_time_zones>

The code below takes the `statics` set from the *iBats* package and adds the *Night* column, @tbl-night shows a selection of 5 rows from the `statics` data.

```{r}
#| code-fold: show


statics_with_night <- iBats::date_time_info(statics)

```

```{r}
#| label: tbl-night
#| tbl-cap: "The Night from the DateTime Column"

statics_with_night %>% 
  sample_n(5) %>% 
  select(Description, Night, DateTime, Species) %>% 
  # Table made with library(gt)
  gt() %>% 
  tab_style(
    style = list(
      cell_fill(color = "midnightblue"),
      cell_text(color = "white"),
      cell_text(weight = "normal")
      ),
    locations = cells_body(
      columns = Night
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "midnightblue"),
      cell_text(color = "white"),
      cell_text(weight = "bold")
      ),
    locations = cells_column_labels(
      columns = Night
    )
  )
```

### Other Date and Time Information added

The function `iBats::date_time_info()` adds other date and time information: month, year and time see @tbl-other (note: not all columns are shown). @tbl-other shows a random selection of 5 rows from the `statics` set.

```{r}
#| label: tbl-other
#| tbl-cap: "Other Date and Time Information from the DateTime Column"

statics_with_night %>% 
  sample_n(5) %>% 
  select(Description, DateTime, Species, Month, MonthFull, Year, JustTime) %>% 
  # Table made with library(gt)
  gt() %>% 
  tab_style(
    style = list(
      cell_fill(color = "lightcyan"),
      cell_text(color = "black"),
      cell_text(weight = "normal")
      ),
    locations = cells_body(
      columns = c(Month, MonthFull, Year, JustTime)
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "lightcyan"),
      cell_text(color = "black"),
      cell_text(weight = "bold")
      ),
    locations = cells_column_labels(
      columns = c(Month, MonthFull, Year, JustTime)
    )
  )
```

## Sun Times

A useful approach for bat data analysis is to reference all bat activity (i.e. `DateTime`) to the time of sunset and sunrise for the `Night` and location(i.e. `Latitude` and `Longitude`). From this starting point, the minutes after sunset (and minutes before sunrise) that each bat activity occurred can be calculated; these can then be converted to decimal hours and integer hours so bat activity can be visualised in ways that help interpret the bat activity.

Referencing the `DateTime` of bat activity to sunset and sunrise is achieved with the use of the `suncalc` package [@R-suncalc]. The `iBats` package makes use of `suncalc` in its `sun_night_metrics` fuction; this takes a dataframe that must include the columns: `Night`, `DateTime`, `Latitude` and, `Longitude` - and calculates the following columns:

* `sunset` - sun set time for the `Night` date and `Latitude` and, `Longitude`
* `sunrise` - sun rise time for the `Night` date and `Latitude` and, `Longitude`
* `post_set_min`- time in minutes the bat was observed after sun set
* `pre_rise_min` - time in minutes the bat was observed before sun rise 
* `post_set_hr` - time in hours (decimal) the bat was observed after sun set
* `pre_rise_hr` - time in hours (decimal) the bat was observed before sun rise
* `post_set_hr_int` - time in hours (integer) the bat was observed after sun set
* `pre_rise_hr_int` - time in hours (integer) the bat was observed before sun rise  
* `night_length_hr` - night length in hours (decimal) difference between `sunset` and `sunrise`

@tbl-suntimes  shows a selection of 5 rows from the `statics` data that includes the columns `Species` and `DateTime` and then calculates the columns listed above, the following columns are shown: `sunset`, `post_set_min`, `post_set_hr` and, `post_set_hr_int`.

```{r}
#| label: tbl-suntimes
#| tbl-cap: "Sun Time Information from the Night and DateTime Columns"

# Add data and time information to the statics data using the iBats::date_time_info
statics_plus <- iBats::date_time_info(statics)

# Add sun and night time metrics to the statics data using the iBats::sun_night_metrics() function.
statics_plus <- iBats::sun_night_metrics(statics_plus)

statics_plus %>% 
  sample_n(5) %>% 
  select(Species, DateTime, sunset, post_set_min, post_set_hr, post_set_hr_int) %>% 
  # Table made with library(gt)
  gt() %>% 
  tab_style(
    style = list(
      cell_fill(color = "pink"),
      cell_text(color = "black"),
      cell_text(weight = "normal")
      ),
    locations = cells_body(
      columns = c(sunset, post_set_min, post_set_hr, post_set_hr_int)
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "pink"),
      cell_text(color = "black"),
      cell_text(weight = "bold")
      ),
    locations = cells_column_labels(
      columns = c(sunset, post_set_min, post_set_hr, post_set_hr_int)
    )
  )



```



